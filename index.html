<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for the details/summary elements to make them look like cards */
        details[open] summary ~ * {
            animation: sweep .3s ease-in-out;
        }
        @keyframes sweep {
            0%  {opacity: 0; margin-left: -10px}
            100%  {opacity: 1; margin-left: 0px}
        }
        /* Rotates the chevron when the details element is open */
        details[open] summary .chevron-icon {
            transform: rotate(180deg);
        }
        /* Custom style for the active lesson button */
        .active-lesson-button {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen p-4">

    <!-- Main container for the layout -->
    <div class="flex flex-col md:flex-row gap-6 max-w-6xl w-full">

        <!-- Left Sidebar for Search, Chapter and Lesson Buttons -->
        <div class="w-full md:w-1/4 space-y-4">
            <!-- Search Input Field -->
            <div class="bg-white rounded-lg shadow-xl p-4">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">Search Questions & Answers</label>
                <input type="text" id="search-input" placeholder="e.g., 'amortization' or 'deed'" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            
            <div id="chapter-buttons-container" class="space-y-4">
                <p class="text-center text-gray-500">Loading chapters...</p>
            </div>
        </div>

        <!-- Right side: Main content area for the quiz -->
        <div class="flex-1 bg-white rounded-lg shadow-xl p-8 md:p-12 space-y-8">

            <!-- Header -->
            <h1 class="text-3xl font-bold text-center text-gray-800">Quiz</h1>
            
            <!-- Quiz content will be dynamically inserted here -->
            <div id="quiz-container" class="space-y-6">
                <p class="text-center text-gray-500 text-lg">Please select a lesson from the left to begin the quiz.</p>
            </div>

            <!-- Navigation buttons -->
            <div id="quiz-navigation" class="hidden justify-between items-center mt-8 pt-6 border-t border-gray-200">
                <button id="prevBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all duration-300 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    &laquo; Previous
                </button>
                <button id="nextBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next &raquo;
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts/Feedback -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
          <div class="mt-2 px-7 py-3">
            <p id="modal-content" class="text-sm text-gray-500"></p>
          </div>
          <div class="items-center px-4 py-3">
            <button id="modal-close" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">OK</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        // --- Centralized Quiz Data ---
        const quizData = {
            chapters: [
                {
                    chapter: "The Basics",
                    file: "the-basics.json",
                    lessons: [
                        {
                            title: "Amortization and Terminology",
                            questions: [
                                {
                                    question: "The original amortization term minus the number of payments that have been applied refers to the:",
                                    possibleAnswers: ["Remaining interest", "Remaining term", "Total amortization term", "Loan amount"],
                                    correctAnswer: "Remaining term",
                                },
                            ]
                        },
                        {
                            title: "Legal Terms",
                            questions: [
                                {
                                    question: "If Franklin, a real estate agent, intentionally speaks very highly and enthusiastically about a property he is trying to sell to a client in order to secure the deal, this type of behavior would be:",
                                    possibleAnswers: ["Puffing", "Steering", "Illegal", "Misrepresentation"],
                                    correctAnswer: "Puffing",
                                    explanation: "The term “puffing” can be used to describe “sales talk” that is used to secure a deal. As long as there is no misrepresentation, it is considered a legal practice.",
                                },
                            ]
                        },
                        {
                            title: "Legal and General Principles",
                            questions: [
                                {
                                    question: "Which of these is considered to be an encumbrance?",
                                    possibleAnswers: ["A lease", "A mortgage", "All of these", "An easement"],
                                    correctAnswer: "All of these",
                                    explanation: "A lease, mortgage, easement, or restriction is considered an encumbrance of a fee simple title.",
                                },
                                {
                                    question: "A broker acting as agent for a principal has as much authority as:",
                                    possibleAnswers: ["other parties believe the agent to possess.", "the agent chooses to accept.", "the principal actually or ostensibly confers upon him.", "he chooses to accept as limited by the Statute of Limitations."],
                                    correctAnswer: "the principal actually or ostensibly confers upon him.",
                                    explanation: "An agent has as much authority as his principal actually or ostensibly confers upon him.",
                                },
                                {
                                    question: "What does a general warranty deed contain?",
                                    possibleAnswers: ["None of these.", "Covenants regarding quiet enjoyment", "Covenants that warrant the new owner’s undisturbed and clear title", "Covenants that include provisions of a quitclaim deed"],
                                    correctAnswer: "Covenants that warrant the new owner’s undisturbed and clear title",
                                    explanation: "Covenants that warrant the new owner’s undisturbed and clear title are contained in a general warranty deed.",
                                },
                                {
                                    question: "In Texas, if Heather is an agent for a buyer Harry and she shows him a property that is known to have ghosts living there according to the neighbors, but she does not inform Harry of this information, after Harry purchases the property, Heather would:",
                                    possibleAnswers: ["Be considered to have misrepresented Harry", "Be liable for misrepresentation", "Be open to being sued by Harry if he finds out about the ghosts", "Not be liable for the nondisclosure of ghosts"],
                                    correctAnswer: "Not be liable for the nondisclosure of ghosts",
                                    explanation: "In Texas, agents are absolved from any liability regarding nondisclosure of stigmatized properties.",
                                },
                                {
                                    question: "Constructive eviction may allow for a tenant to vacate the premises before the expiration of a lease term. Which would be an example of this?",
                                    possibleAnswers: ["Landlord has shown property to prospective tenant and is negotiating terms", "Property cannot be used for original purpose due to unnecessary and considerable changes made by landlord", "Landlord fails to make necessary repairs", "All of the above"],
                                    correctAnswer: "All of the above",
                                    explanation: "All of the above are examples of constructive eviction. a) Landlord has shown property to prospective tenant and is negotiating terms b) Property cannot be used for original purpose due to unnecessary and considerable changes made by landlord c) Landlord fails to make necessary repairs",
                                },
                                {
                                    question: `"A" receives a life estate for the life of "X." "A" dies before "X." The estate:`,
                                    possibleAnswers: ["ceases to exist.", "reverts to the original grantor.", "vests in", "vests in the heirs of"],
                                    correctAnswer: "vests in the heirs of",
                                    explanation: `The estate vests in the heirs of "A" until "X" dies at which time the estate will revert to the original grantor.`,
                                },
                            ]
                        }
                    ]
                },
                {
                    chapter: "Mortgage Fundamentals",
                    file: "mortgage-fundamentals.json",
                    lessons: [
                        {
                            title: "Mortgage Types",
                            questions: [
                                {
                                    question: "Which of the following is a key characteristic of a fixed-rate mortgage?",
                                    possibleAnswers: ["The interest rate can change over time.", "The interest rate remains the same for the entire loan term.", "The monthly payment fluctuates based on market conditions.", "It is only available for commercial properties."],
                                    correctAnswer: "The interest rate remains the same for the entire loan term.",
                                    explanation: "A fixed-rate mortgage is a loan where the interest rate and monthly payment remain constant throughout the entire loan term.",
                                },
                            ]
                        },
                        {
                            title: "Property Ownership",
                            questions: [
                                {
                                    question: "What is a deed?",
                                    possibleAnswers: ["A contract for a loan.", "A legal document that transfers ownership of a property.", "A property tax bill.", "A certificate of occupancy."],
                                    correctAnswer: "A legal document that transfers ownership of a property.",
                                    explanation: "A deed is a legal instrument used to transfer title or ownership of real property from one person to another.",
                                },
                            ]
                        },
                        {
                            title: "Contracts and Clauses",
                            questions: [
                                {
                                    question: "What is a mortgage contingency?",
                                    possibleAnswers: ["A penalty for paying off a mortgage early.", "A clause in a purchase agreement that protects the buyer if they cannot secure financing.", "An additional fee added to the mortgage interest rate.", "A type of insurance for the property owner."],
                                    correctAnswer: "A clause in a purchase agreement that protects the buyer if they cannot secure financing.",
                                    explanation: "A mortgage contingency is a clause in a sales contract that specifies the sale is dependent on the buyer getting a mortgage for the property. If the buyer can't get a mortgage, they can cancel the contract without penalty.",
                                },
                            ]
                        },
                        {
                            title: "Valuation Principles",
                            questions: [
                                {
                                    question: "A couple is looking at houses and turns one down because they felt the price of the home was too high. This is based on what principle of real estate?",
                                    possibleAnswers: ["Conformity", "Anticipation", "Substitution", "All of these"],
                                    correctAnswer: "Substitution",
                                    explanation: "The principle of substitution is the basis of the appraisal process. Explained simply, value is set by the cost of getting an equally desirable substitute.",
                                },
                            ]
                        }
                    ]
                },
                {
                    chapter: "The Closing Process",
                    file: "the-closing-process.json",
                    lessons: [
                        {
                            title: "Closing Costs",
                            questions: [
                                {
                                    question: "Which of the following is typically considered a closing cost?",
                                    possibleAnswers: ["Utility bills", "Property taxes", "Earnest money deposit", "Home appraisal fee"],
                                    correctAnswer: "Home appraisal fee",
                                    explanation: "Closing costs are fees associated with the purchase of a home. A home appraisal fee is a common example, while property taxes and utility bills are ongoing expenses, and an earnest money deposit is a credit toward the purchase price.",
                                },
                                {
                                    question: "What is a 'title search'?",
                                    possibleAnswers: ["A search for a buyer for the property.", "A legal review of a property's history to ensure clear ownership.", "A physical inspection of the property's condition.", "A check of the buyer's credit history."],
                                    correctAnswer: "A legal review of a property's history to ensure clear ownership.",
                                    explanation: "A title search is a process to confirm that the person selling the property has the legal right to do so and that there are no liens or other claims against it.",
                                },
                            ]
                        },
                        {
                            title: "Escrow and Title",
                            questions: [
                                {
                                    question: "What is the purpose of an escrow account?",
                                    possibleAnswers: ["To hold funds for future property repairs.", "To save for a down payment.", "To hold funds and documents during a real estate transaction.", "To pay the real estate agent's commission."],
                                    correctAnswer: "To hold funds and documents during a real estate transaction.",
                                    explanation: "An escrow account is an account held by a third party (an escrow agent) on behalf of two parties in a transaction, holding the funds and documents until all conditions are met.",
                                },
                            ]
                        }
                    ]
                },
                {
                    chapter: "Investment Properties",
                    file: "investment-properties.json",
                    lessons: [
                        {
                            title: "Types of Investment",
                            questions: [
                                {
                                    question: "What is the term for a property purchased with the intention of generating income through rent?",
                                    possibleAnswers: ["Primary residence", "Second home", "Rental property", "Vacation home"],
                                    correctAnswer: "Rental property",
                                    explanation: "A rental property is a real estate investment where the owner leases the property to tenants to generate income.",
                                },
                            ]
                        },
                        {
                            title: "Financial Metrics",
                            questions: [
                                {
                                    question: "What does 'Cap Rate' stand for in real estate investment?",
                                    possibleAnswers: ["Capitalization Rate", "Closing Asset Price", "Cash Asset Ratio", "Credit Application Ratio"],
                                    correctAnswer: "Capitalization Rate",
                                    explanation: "Capitalization Rate (Cap Rate) is a financial metric used to estimate the potential return on a real estate investment. It is the ratio of net operating income to the property's asset value.",
                                },
                            ]
                        }
                    ]
                },
                {
                    chapter: "Real Estate Financing",
                    file: "real-estate-financing.json",
                    lessons: [
                        {
                            title: "Loan Types",
                            questions: [
                                {
                                    question: "Which loan is backed by the U.S. government and is popular for first-time homebuyers?",
                                    possibleAnswers: ["Conventional loan", "FHA loan", "Jumbo loan", "Bridge loan"],
                                    correctAnswer: "FHA loan",
                                    explanation: "An FHA loan is a mortgage issued by an FHA-approved lender and insured by the Federal Housing Administration. They are popular with first-time homebuyers due to lower down payment requirements.",
                                },
                            ]
                        },
                        {
                            title: "Credit and Debt",
                            questions: [
                                {
                                    question: "What is a 'debt-to-income' ratio (DTI)?",
                                    possibleAnswers: ["A ratio of all your income to all your expenses.", "A ratio of your gross income to your net income.", "A ratio of your monthly debt payments to your gross monthly income.", "A ratio of your credit score to your total debt."],
                                    correctAnswer: "A ratio of your monthly debt payments to your gross monthly income.",
                                    explanation: "The debt-to-income (DTI) ratio is a personal finance measure that compares your total monthly debt payments to your gross monthly income. It helps lenders assess your ability to manage monthly payments.",
                                },
                            ]
                        },
                        {
                            title: "Economic Influences",
                            questions: [
                                {
                                    question: `Which of the following courses of action would the Federal Reserve Board take during an elongated period of "tight money?"`,
                                    possibleAnswers: ["Any of the following", "Purchasing large blocks of government bonds", "Lower the reserve requirements of bank members", "Decrease the discount rate for bank members"],
                                    correctAnswer: "Any of the following",
                                    explanation: `Answers (a), (b), (c), and (d) are all courses of action taken by the Federal Reserve Board to help alleviate tight money conditions in the country.`,
                                },
                            ]
                        }
                    ]
                }
            ]
        };

        // --- Main Quiz App Logic ---

        // State variables to keep track of the current position in the quiz
        let currentChapterIndex = -1; // -1 indicates no lesson is selected
        let currentLessonIndex = -1; // -1 indicates no lesson is selected
        let currentQuestionIndex = 0;
        let isAnswerSubmitted = false; // New state variable to control 'Next' button
        let isSearchMode = false; // New state variable for search mode

        // DOM element references
        const quizContainer = document.getElementById('quiz-container');
        const chapterButtonsContainer = document.getElementById('chapter-buttons-container');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const quizNavigation = document.getElementById('quiz-navigation');
        const searchInput = document.getElementById('search-input');

        // Modal element references
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close');

        // Function to show a custom modal (replaces alert())
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalContent.textContent = message;
            modal.classList.remove('hidden');
        }

        // Close modal button event listener
        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Function to render the current question and its options
        function renderQuiz() {
            // Reset the 'answer submitted' state for a new question
            isAnswerSubmitted = false;

            // Check if a lesson is currently selected
            if (currentChapterIndex === -1) {
                quizContainer.innerHTML = `<p class="text-center text-gray-500 text-lg">Please select a lesson from the left to begin the quiz.</p>`;
                quizNavigation.classList.add('hidden');
                return;
            }

            const currentChapter = quizData.chapters[currentChapterIndex];
            const currentLesson = currentChapter.lessons[currentLessonIndex];
            const currentQuestion = currentLesson.questions[currentQuestionIndex];
            const totalQuestions = currentLesson.questions.length;

            // Build the HTML for the current question
            quizContainer.innerHTML = `
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800">${currentChapter.chapter}</h2>
                    <h3 class="text-xl font-semibold text-gray-700">${currentLesson.title}</h3>
                </div>
                <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                    <p class="text-lg font-medium text-gray-700">Question ${currentQuestionIndex + 1}/${totalQuestions}:</p>
                    <p class="text-xl font-semibold mt-2">${currentQuestion.question}</p>
                    <div class="mt-4 space-y-3">
                        ${currentQuestion.possibleAnswers.map((answer, index) => `
                            <label class="block cursor-pointer p-4 rounded-lg bg-white border border-gray-200 hover:bg-blue-50 transition-colors duration-200">
                                <input type="radio" name="answer" value="${answer}" class="mr-2">
                                <span class="text-gray-800">${answer}</span>
                            </label>
                        `).join('')}
                    </div>
                    <button id="submitBtn" class="mt-6 w-full py-3 px-6 bg-green-600 text-white rounded-lg shadow-md transition-all duration-300 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Submit Answer
                    </button>
                    <div id="feedback-container" class="mt-4 p-4 rounded-lg hidden"></div>
                </div>
            `;
            quizNavigation.classList.remove('hidden');

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.addEventListener('click', handleSubmit);
            updateNavButtons();
        }

        // Function to handle answer submission
        function handleSubmit() {
            const selectedAnswer = document.querySelector('input[name="answer"]:checked')?.value;
            const currentQuestion = quizData.chapters[currentChapterIndex].lessons[currentLessonIndex].questions[currentQuestionIndex];
            const feedbackContainer = document.getElementById('feedback-container');

            if (!selectedAnswer) {
                showModal('Answer Required', 'Please select an answer before submitting.');
                return;
            }

            feedbackContainer.classList.remove('hidden');
            const isCorrect = selectedAnswer === currentQuestion.correctAnswer;

            let feedbackHTML = '';
            if (isCorrect) {
                feedbackHTML = `
                    <div class="bg-green-100 text-green-700 p-4 rounded-lg">
                        <p class="font-bold">Correct!</p>
                        ${currentQuestion.explanation ? `<p class="mt-2">${currentQuestion.explanation}</p>` : ''}
                    </div>
                `;
            } else {
                feedbackHTML = `
                    <div class="bg-red-100 text-red-700 p-4 rounded-lg">
                        <p class="font-bold">Incorrect.</p>
                        <p class="mt-2">The correct answer is: <strong>${currentQuestion.correctAnswer}</strong>.</p>
                        ${currentQuestion.explanation ? `<p class="mt-2">${currentQuestion.explanation}</p>` : ''}
                    </div>
                `;
            }
            feedbackContainer.innerHTML = feedbackHTML;
            document.getElementById('submitBtn').disabled = true;

            // Mark the question as answered and update the nav buttons
            isAnswerSubmitted = true;
            updateNavButtons();
        }

        // Function to handle loading a new lesson when a button is clicked
        function handleLessonButtonClick(chapterIdx, lessonIdx) {
            currentChapterIndex = chapterIdx;
            currentLessonIndex = lessonIdx;
            currentQuestionIndex = 0;
            isSearchMode = false;
            updateUI();
        }
        
        // Function to render the sidebar navigation with full chapters
        function renderSidebar() {
            chapterButtonsContainer.innerHTML = ''; // Clear previous buttons

            quizData.chapters.forEach((chapter, chapterIdx) => {
                const chapterDetails = document.createElement('details');
                chapterDetails.className = `w-full bg-white rounded-lg shadow-xl p-6 transition-all duration-300 open:bg-gray-100`;

                // Set the details to open if it's the current chapter
                if (chapterIdx === currentChapterIndex) {
                    chapterDetails.open = true;
                }
                
                const chapterSummary = document.createElement('summary');
                chapterSummary.className = 'list-none text-xl font-bold text-gray-800 cursor-pointer flex items-center justify-between hover:text-blue-600 transition-colors duration-200';
                chapterSummary.innerHTML = `
                    <span>${chapter.chapter}</span>
                    <svg class="chevron-icon w-5 h-5 text-gray-500 transform transition-transform duration-300" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                `;
                chapterDetails.appendChild(chapterSummary);
                
                const lessonContainer = document.createElement('div');
                lessonContainer.className = 'space-y-2 mt-4';
                
                // Add lesson buttons
                chapter.lessons.forEach((lesson, lessonIdx) => {
                    const lessonButton = document.createElement('button');
                    lessonButton.textContent = lesson.title;
                    lessonButton.className = `w-full text-left py-2 px-3 rounded-lg transition-all duration-200 text-wrap break-words bg-gray-200 text-gray-700 hover:bg-gray-300`;

                    // Add a special class for the active lesson
                    if (chapterIdx === currentChapterIndex && lessonIdx === currentLessonIndex) {
                        lessonButton.classList.add('active-lesson-button');
                    }

                    lessonButton.addEventListener('click', () => handleLessonButtonClick(chapterIdx, lessonIdx));
                    lessonContainer.appendChild(lessonButton);
                });

                chapterDetails.appendChild(lessonContainer);
                chapterButtonsContainer.appendChild(chapterDetails);
            });
        }
        
        // New function to render search results
        function renderSearchResults(results) {
            chapterButtonsContainer.innerHTML = '';
            if (results.length === 0) {
                chapterButtonsContainer.innerHTML = `<p class="text-center text-gray-500 text-md p-4">No results found.</p>`;
                return;
            }

            results.forEach(result => {
                const resultDetails = document.createElement('details');
                resultDetails.className = `w-full bg-white rounded-lg shadow-xl p-4 transition-all duration-300`;

                const resultSummary = document.createElement('summary');
                resultSummary.className = 'list-none text-md font-semibold text-gray-800 cursor-pointer flex items-center justify-between hover:text-blue-600 transition-colors duration-200';
                resultSummary.innerHTML = `
                    <span>${result.question}</span>
                    <svg class="chevron-icon w-5 h-5 text-gray-500 transform transition-transform duration-300" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                `;
                resultDetails.appendChild(resultSummary);

                const resultContent = document.createElement('div');
                resultContent.className = 'space-y-2 mt-4 text-sm';
                resultContent.innerHTML = `
                    <p class="font-bold text-gray-700">Correct Answer:</p>
                    <p class="text-green-700 font-semibold">${result.correctAnswer}</p>
                    ${result.explanation ? `<p class="font-bold text-gray-700 mt-3">Explanation:</p><p class="text-gray-600">${result.explanation}</p>` : ''}
                `;
                resultDetails.appendChild(resultContent);

                chapterButtonsContainer.appendChild(resultDetails);
            });
        }

        // Event listener for the search input
        searchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase().trim();
            if (searchTerm.length > 0) {
                isSearchMode = true;
                currentChapterIndex = -1;
                currentLessonIndex = -1;
                quizContainer.innerHTML = `<p class="text-center text-gray-500 text-lg">Showing search results. Select a lesson to start a quiz.</p>`;
                quizNavigation.classList.add('hidden');
                
                // Flatten the quiz data to search all questions
                let allQuestions = [];
                quizData.chapters.forEach(chapter => {
                    chapter.lessons.forEach(lesson => {
                        allQuestions.push(...lesson.questions);
                    });
                });

                // Filter the questions based on the search term
                const searchResults = allQuestions.filter(question => {
                    const questionText = question.question.toLowerCase();
                    const correctAnswerText = question.correctAnswer.toLowerCase();
                    const possibleAnswersText = question.possibleAnswers.map(ans => ans.toLowerCase()).join(' ');
                    const explanationText = question.explanation ? question.explanation.toLowerCase() : '';
                    
                    return questionText.includes(searchTerm) || 
                           correctAnswerText.includes(searchTerm) || 
                           possibleAnswersText.includes(searchTerm) || 
                           explanationText.includes(searchTerm);
                });

                renderSearchResults(searchResults);
            } else {
                isSearchMode = false;
                renderSidebar();
                quizContainer.innerHTML = `<p class="text-center text-gray-500 text-lg">Please select a lesson from the left to begin the quiz.</p>`;
                quizNavigation.classList.add('hidden');
            }
        });


        // Function to update the state of navigation buttons
        function updateNavButtons() {
            if (currentChapterIndex === -1) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }

            const currentChapter = quizData.chapters[currentChapterIndex];
            const currentLesson = currentChapter.lessons[currentLessonIndex];
            
            const isFirstQuestion = currentChapterIndex === 0 && currentLessonIndex === 0 && currentQuestionIndex === 0;
            const isLastQuestionOfLesson = currentQuestionIndex === currentLesson.questions.length - 1;
            const isLastLessonOfChapter = currentLessonIndex === currentChapter.lessons.length - 1;
            const isLastChapter = currentChapterIndex === quizData.chapters.length - 1;

            prevBtn.disabled = isFirstQuestion;
            nextBtn.disabled = !isAnswerSubmitted || (isLastQuestionOfLesson && isLastLessonOfChapter && isLastChapter);
        }

        // Event listener for the "Next" button
        nextBtn.addEventListener('click', () => {
            // Only proceed if an answer has been submitted for the current question
            if (!isAnswerSubmitted) {
                showModal('Answer Required', 'Please submit your answer before moving to the next question.');
                return;
            }

            const currentChapter = quizData.chapters[currentChapterIndex];
            const currentLesson = currentChapter.lessons[currentLessonIndex];

            // Check if there is a next question in the current lesson
            if (currentQuestionIndex < currentLesson.questions.length - 1) {
                currentQuestionIndex++;
            } else if (currentLessonIndex < currentChapter.lessons.length - 1) {
                // Move to the next lesson
                currentLessonIndex++;
                currentQuestionIndex = 0;
            } else if (currentChapterIndex < quizData.chapters.length - 1) {
                // Move to the next chapter's first lesson
                currentChapterIndex++;
                currentLessonIndex = 0;
                currentQuestionIndex = 0;
            } else {
                // End of quiz
                showModal('Congratulations!', 'You have completed all the quiz questions!');
                return;
            }
            
            updateUI();
        });

        // Event listener for the "Previous" button
        prevBtn.addEventListener('click', () => {
            // Check if there is a previous question in the current lesson
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
            } else if (currentLessonIndex > 0) {
                // Move to the previous lesson's last question
                currentLessonIndex--;
                currentQuestionIndex = quizData.chapters[currentChapterIndex].lessons[currentLessonIndex].questions.length - 1;
            } else if (currentChapterIndex > 0) {
                // Move to the previous chapter's last lesson's last question
                currentChapterIndex--;
                currentLessonIndex = quizData.chapters[currentChapterIndex].lessons.length - 1;
                currentQuestionIndex = quizData.chapters[currentChapterIndex].lessons[currentLessonIndex].questions.length - 1;
            } else {
                // Already at the very first question, nothing to do
                return;
            }

            updateUI();
        });
        
        // Main function to update all UI components
        function updateUI() {
            // Only render the sidebar with full content if not in search mode
            if (!isSearchMode) {
                renderSidebar();
            }
            renderQuiz();
        }

        // Initial render when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
        });
    </script>
</body>
</html>
