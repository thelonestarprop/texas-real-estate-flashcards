<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styling for the details/summary elements to make them look like cards */
        details[open] summary ~ * {
            animation: sweep .3s ease-in-out;
        }
        @keyframes sweep {
            0% { opacity: 0; margin-left: -10px; }
            100% { opacity: 1; margin-left: 0px; }
        }
        /* Rotates the chevron when the details element is open */
        details[open] summary .chevron-icon {
            transform: rotate(180deg);
        }
        /* Custom style for the active lesson button */
        .active-lesson-button {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen p-4">

    <!-- Main container for the layout -->
    <div class="flex flex-col md:flex-row gap-6 max-w-6xl w-full">

        <!-- Left Sidebar for Search, Chapter and Lesson Buttons -->
        <div class="w-full md:w-1/4 space-y-4">
            <!-- Search Input Field -->
            <div class="bg-white rounded-lg shadow-xl p-4 sticky top-4 z-10">
                <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">Search Questions & Answers</label>
                <input type="text" id="search-input" placeholder="e.g., 'amortization' or 'deed'" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            
            <div id="chapter-buttons-container" class="space-y-4">
                <p id="loading-text" class="text-center text-gray-500">Loading chapters...</p>
            </div>
        </div>

        <!-- Right side: Main content area for the quiz -->
        <div class="flex-1 bg-white rounded-lg shadow-xl p-8 md:p-12 space-y-8">

            <!-- Header -->
            <h1 id="main-quiz-title" class="text-3xl font-bold text-center text-gray-800">Quiz</h1>
            
            <!-- Quiz content will be dynamically inserted here -->
            <div id="quiz-container" class="space-y-6">
                <p id="initial-message" class="text-center text-gray-500 text-lg">Please select a lesson from the left to begin the quiz.</p>
            </div>

            <!-- Navigation buttons -->
            <div id="quiz-navigation" class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200 hidden">
                <button id="prevBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all duration-300 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    &laquo; Previous
                </button>
                <button id="nextBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-300 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next &raquo;
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts/Feedback -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
          <div class="mt-2 px-7 py-3">
            <p id="modal-content" class="text-sm text-gray-500"></p>
          </div>
          <div class="items-center px-4 py-3">
            <button id="modal-close" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">OK</button>
          </div>
        </div>
      </div>
    </div>

    <script>
        // --- Centralized Quiz Data (Your original data) ---
        const quizData = {
            chapters: [
                {
                    chapter: "Quiz 1",
                    file: "the-basics.json",
                    lessons: [
                        {
                            title: "Amortization and Terminology",
                            questions: [
                                
                                {
      "question": "Which of these is considered to be an encumbrance?",
      "possibleAnswers": ["A lease", "A mortgage", "All of these", "An easement"],
      "correctAnswer": "All of these",
      "explanation": "A lease, mortgage, easement, or restriction is considered an encumbrance of a fee simple title."
    },
                                {
      "question": "Which of the following courses of action would the Federal Reserve Board take during an elongated period of \"tight money?\"",
      "possibleAnswers": [
        "Any of the following",
        "Purchasing large blocks of government bonds",
        "Lower the reserve requirements of bank members",
        "Decrease the discount rate for bank members"
      ],
      "correctAnswer": "Any of the following",
      "explanation": "Answers (a), (b), (c), and (d) are all courses of action taken by the Federal Reserve Board to help alleviate tight money conditions in the country."
    },
                                {
      "question": "A broker acting as agent for a principal has as much authority as:",
      "possibleAnswers": [
        "other parties believe the agent to possess.",
        "the agent chooses to accept.",
        "the principal actually or ostensibly confers upon him.",
        "he chooses to accept as limited by the Statute of Limitations."
      ],
      "correctAnswer": "the principal actually or ostensibly confers upon him.",
      "explanation": "An agent has as much authority as his principal actually or ostensibly confers upon him."
    },
                                {
      "question": "What does a general warranty deed contain?",
      "possibleAnswers": [
        "None of these.",
        "Covenants regarding quiet enjoyment",
        "Covenants that warrant the new owner’s undisturbed and clear title",
        "Covenants that include provisions of a quitclaim deed"
      ],
      "correctAnswer": "Covenants that warrant the new owner’s undisturbed and clear title",
      "explanation": "Covenants that warrant the new owner’s undisturbed and clear title are contained in a general warranty deed."
    },
    {
      "question": "In Texas, if Heather is an agent for a buyer Harry and she shows him a property that is known to have ghosts living there according to the neighbors, but she does not inform Harry of this information, after Harry purchases the property, Heather would:",
      "possibleAnswers": [
        "Be considered to have misrepresented Harry",
        "Be liable for misrepresentation",
        "Be open to being sued by Harry if he finds out about the ghosts",
        "Not be liable for the nondisclosure of ghosts"
      ],
      "correctAnswer": "Not be liable for the nondisclosure of ghosts",
      "explanation": "In Texas, agents are absolved from any liability regarding nondisclosure of stigmatized properties."
    },        
                               {
      "question": "A couple is looking at houses and turns one down because they felt the price of the home was too high. This is based on what principle of real estate?",
      "possibleAnswers": ["Conformity", "Anticipation", "Substitution", "All of these"],
      "correctAnswer": "Substitution",
      "explanation": "The principle of substitution is the basis of the appraisal process. Explained simply, value is set by the cost of getting an equally desirable substitute."
    },      
                                {
      "question": "Constructive eviction may allow for a tenant to vacate the premises before the expiration of a lease term. Which would be an example of this?",
      "possibleAnswers": [
        "Landlord has shown property to prospective tenant and is negotiating terms",
        "Property cannot be used for original purpose due to unnecessary and considerable changes made by landlord",
        "Landlord fails to make necessary repairs",
        "All of the above"
      ],
      "correctAnswer": "All of the above",
      "explanation": "All of the above are examples of constructive eviction. a) Landlord has shown property to prospective tenant and is negotiating terms b) Property cannot be used for original purpose due to unnecessary and considerable changes made by landlord c) Landlord fails to make necessary repairs"
    },
                                {
      "question": "\"A\" receives a life estate for the life of \"X.\" \"A\" dies before \"X.\" The estate:",
      "possibleAnswers": [
        "ceases to exist.",
        "reverts to the original grantor.",
        "vests in",
        "vests in the heirs of"
      ],
      "correctAnswer": "vests in the heirs of",
      "explanation": "The estate vests in the heirs of \"A\" until \"X\" dies at which time the estate will revert to the original grantor."
    },
                                {
      "question": "The original amortization term minus the number of payments that have been applied refers to the:",
      "possibleAnswers": [
        "Remaining interest",
        "Remaining term",
        "Total amortization term",
        "Loan amount"
      ],
      "correctAnswer": "Remaining term",
      "explanation": "The original amortization term minus the number of payments that have been applied refers to the remaining term."
    },
                                {
      "question": "If Franklin, a real estate agent, intentionally speaks very highly and enthusiastically about a property he is trying to sell to a client in order to secure the deal, this type of behavior would be:",
      "possibleAnswers": ["Puffing", "Steering", "Illegal", "Misrepresentation"],
      "correctAnswer": "Puffing",
      "explanation": "The term “puffing” can be used to describe “sales talk” that is used to secure a deal. As long as there is no misrepresentation, it is considered a legal practice."
    },
<!-- NEXT 3 QUESTOINS FOLLOWING QUESTIONS ARE GENERATED BY GEMINI -->
                                {
                                    question: "The original amortization term minus the number of payments that have been applied refers to the:",
                                    possibleAnswers: ["Remaining interest", "Remaining term", "Total amortization term", "Loan amount"],
                                    correctAnswer: "Remaining term",
                                    explanation: "The remaining term is the duration of a loan left after a certain number of payments have been made."
                                },
                                {
                                    question: "What is an appraisal?",
                                    possibleAnswers: ["A tax assessment of a property's value.", "An estimate of a property's value by a professional appraiser.", "A final offer price from a buyer.", "A legally binding contract of sale."],
                                    correctAnswer: "An estimate of a property's value by a professional appraiser.",
                                    explanation: "An appraisal is a professional and unbiased opinion of a home's value based on a variety of factors, including its condition, location, and recent sales of comparable properties."
                                },
                                {
                                    question: "What is the process of paying off a debt in regular installments over a period of time?",
                                    possibleAnswers: ["Foreclosure", "Refinancing", "Amortization", "Escrow"],
                                    correctAnswer: "Amortization",
                                    explanation: "Amortization is the process of paying off a debt with a fixed repayment schedule in regular installments over a period of time, such as with a mortgage."
                                }
                            ]
                        },
                        {
                            title: "Legal Terms",
                            questions: [
                                {
                                    question: "If Franklin, a real estate agent, intentionally speaks very highly and enthusiastically about a property he is trying to sell to a client in order to secure the deal, this type of behavior would be:",
                                    possibleAnswers: ["Puffing", "Steering", "Illegal", "Misrepresentation"],
                                    correctAnswer: "Puffing",
                                    explanation: "The term “puffing” can be used to describe “sales talk” that is used to secure a deal. As long as there is no misrepresentation, it is considered a legal practice."
                                },
                                {
                                    question: "What is a 'lien'?",
                                    possibleAnswers: ["A type of property insurance.", "A legal claim on a property to secure payment of a debt.", "A document that transfers property ownership.", "The legal right to use another person's property."],
                                    correctAnswer: "A legal claim on a property to secure payment of a debt.",
                                    explanation: "A lien is a legal claim or a hold against a property until a debt is paid off. Examples include mortgages and tax liens."
                                },
                                {
                                    question: "The legal right to use another person's property for a specific purpose is called:",
                                    possibleAnswers: ["A deed", "An easement", "A lien", "A covenant"],
                                    correctAnswer: "An easement",
                                    explanation: "An easement grants the right to use or enter another person's property without possessing it. A common example is a utility company's right to access a part of your land to maintain power lines."
                                }
                            ]
                        },
                        {
                            title: "Legal and General Principles",
                            questions: [
                                {
                                    question: "Which of these is considered to be an encumbrance?",
                                    possibleAnswers: ["A lease", "A mortgage", "All of these", "An easement"],
                                    correctAnswer: "All of these",
                                    explanation: "A lease, mortgage, easement, or restriction is considered an encumbrance of a fee simple title."
                                },
                                {
                                    question: "A broker acting as agent for a principal has as much authority as:",
                                    possibleAnswers: ["other parties believe the agent to possess.", "the agent chooses to accept.", "the principal actually or ostensibly confers upon him.", "he chooses to accept as limited by the Statute of Limitations."],
                                    correctAnswer: "the principal actually or ostensibly confers upon him.",
                                    explanation: "An agent has as much authority as his principal actually or ostensibly confers upon him."
                                },
                                {
                                    question: "What does a general warranty deed contain?",
                                    possibleAnswers: ["None of these.", "Covenants regarding quiet enjoyment", "Covenants that warrant the new owner’s undisturbed and clear title", "Covenants that include provisions of a quitclaim deed"],
                                    correctAnswer: "Covenants that warrant the new owner’s undisturbed and clear title",
                                    explanation: "Covenants that warrant the new owner’s undisturbed and clear title are contained in a general warranty deed."
                                },
                                {
                                    question: "In Texas, if Heather is an agent for a buyer Harry and she shows him a property that is known to have ghosts living there according to the neighbors, but she does not inform Harry of this information, after Harry purchases the property, Heather would:",
                                    possibleAnswers: ["Be considered to have misrepresented Harry", "Be liable for misrepresentation", "Be open to being sued by Harry if he finds out about the ghosts", "Not be liable for the nondisclosure of ghosts"],
                                    correctAnswer: "Not be liable for the nondisclosure of ghosts",
                                    explanation: "In Texas, agents are absolved from any liability regarding nondisclosure of stigmatized properties."
                                },
                                {
                                    question: "Constructive eviction may allow for a tenant to vacate the premises before the expiration of a lease term. Which would be an example of this?",
                                    possibleAnswers: ["Landlord has shown property to prospective tenant and is negotiating terms", "Property cannot be used for original purpose due to unnecessary and considerable changes made by landlord", "Landlord fails to make necessary repairs", "All of the above"],
                                    correctAnswer: "All of the above",
                                    explanation: "All of the above are examples of constructive eviction. a) Landlord has shown property to prospective tenant and is negotiating terms b) Property cannot be used for original purpose due to unnecessary and considerable changes made by landlord c) Landlord fails to make necessary repairs"
                                },
                                {
                                    question: `"A" receives a life estate for the life of "X." "A" dies before "X." The estate:`,
                                    possibleAnswers: ["ceases to exist.", "reverts to the original grantor.", "vests in", "vests in the heirs of"],
                                    correctAnswer: "vests in the heirs of",
                                    explanation: `The estate vests in the heirs of "A" until "X" dies at which time the estate will revert to the original grantor.`
                                }
                            ]
                        }
                    ]
                },
                {
                    chapter: "Mortgage Fundamentals",
                    file: "mortgage-fundamentals.json",
                    lessons: [
                        {
                            title: "Mortgage Types",
                            questions: [
                                {
                                    question: "Which of the following is a key characteristic of a fixed-rate mortgage?",
                                    possibleAnswers: ["The interest rate can change over time.", "The interest rate remains the same for the entire loan term.", "The monthly payment fluctuates based on market conditions.", "It is only available for commercial properties."],
                                    correctAnswer: "The interest rate remains the same for the entire loan term.",
                                    explanation: "A fixed-rate mortgage is a loan where the interest rate and monthly payment remain constant throughout the entire loan term."
                                },
                                {
                                    question: "An adjustable-rate mortgage (ARM) is a mortgage loan where the interest rate on the loan:",
                                    possibleAnswers: ["Is fixed for the life of the loan.", "Can change at pre-determined intervals.", "Is adjusted daily based on market rates.", "Is only available for jumbo loans."],
                                    correctAnswer: "Can change at pre-determined intervals.",
                                    explanation: "An ARM's interest rate is tied to an index and can increase or decrease periodically, affecting the monthly payment."
                                },
                                {
                                    question: "What type of mortgage allows a borrower to make interest-only payments for a set period, after which the payments increase to include principal?",
                                    possibleAnswers: ["Fixed-rate mortgage", "Balloon mortgage", "Adjustable-rate mortgage", "Interest-only mortgage"],
                                    correctAnswer: "Interest-only mortgage",
                                    explanation: "An interest-only mortgage allows the borrower to pay only the interest for a set period, which keeps the monthly payments low initially. After this period, the borrower must pay both principal and interest."
                                }
                            ]
                        },
                        {
                            title: "Property Ownership",
                            questions: [
                                {
                                    question: "What is a deed?",
                                    possibleAnswers: ["A contract for a loan.", "A legal document that transfers ownership of a property.", "A property tax bill.", "A certificate of occupancy."],
                                    correctAnswer: "A legal document that transfers ownership of a property.",
                                    explanation: "A deed is a legal instrument used to transfer title or ownership of real property from one person to another."
                                },
                                {
                                    question: "What is a 'fee simple' estate?",
                                    possibleAnswers: ["A type of leasehold estate.", "The most complete form of private ownership of real property.", "Ownership of a property for a fixed term.", "A property owned by a government entity."],
                                    correctAnswer: "The most complete form of private ownership of real property.",
                                    explanation: "Fee simple is a legal term for the ownership of land and all improvements on that land, representing the most extensive rights a person can have in a property."
                                },
                                {
                                    question: "When two or more individuals own property together with equal and undivided interests and the right of survivorship, this is known as:",
                                    possibleAnswers: ["Tenancy in common", "Community property", "Joint tenancy", "Tenancy by the entirety"],
                                    correctAnswer: "Joint tenancy",
                                    explanation: "Joint tenancy is a form of co-ownership where the surviving owners automatically inherit a deceased owner's share of the property."
                                }
                            ]
                        },
                        {
                            title: "Contracts and Clauses",
                            questions: [
                                {
                                    question: "What is a mortgage contingency?",
                                    possibleAnswers: ["A penalty for paying off a mortgage early.", "A clause in a purchase agreement that protects the buyer if they cannot secure financing.", "An additional fee added to the mortgage interest rate.", "A type of insurance for the property owner."],
                                    correctAnswer: "A clause in a purchase agreement that protects the buyer if they cannot secure financing.",
                                    explanation: "A mortgage contingency is a clause in a sales contract that specifies the sale is dependent on the buyer getting a mortgage for the property. If the buyer can't get a mortgage, they can cancel the contract without penalty."
                                },
                                {
                                    question: "A clause in a mortgage that states the entire loan balance is due immediately if the borrower defaults on the loan is called:",
                                    possibleAnswers: ["A prepayment penalty clause", "A due-on-sale clause", "An acceleration clause", "A habendum clause"],
                                    correctAnswer: "An acceleration clause",
                                    explanation: "An acceleration clause gives the lender the right to demand the entire remaining balance of the loan if the borrower fails to make a payment or violates other terms of the mortgage agreement."
                                }
                            ]
                        },
                        {
                            title: "Valuation Principles",
                            questions: [
                                {
                                    question: "A couple is looking at houses and turns one down because they felt the price of the home was too high. This is based on what principle of real estate?",
                                    possibleAnswers: ["Conformity", "Anticipation", "Substitution", "All of these"],
                                    correctAnswer: "Substitution",
                                    explanation: "The principle of substitution is the basis of the appraisal process. Explained simply, value is set by the cost of getting an equally desirable substitute."
                                }
                            ]
                        }
                    ]
                },
                {
                    chapter: "The Closing Process",
                    file: "the-closing-process.json",
                    lessons: [
                        {
                            title: "Closing Costs",
                            questions: [
                                {
                                    question: "Which of the following is typically considered a closing cost?",
                                    possibleAnswers: ["Utility bills", "Property taxes", "Earnest money deposit", "Home appraisal fee"],
                                    correctAnswer: "Home appraisal fee",
                                    explanation: "Closing costs are fees associated with the purchase of a home. A home appraisal fee is a common example, while property taxes and utility bills are ongoing expenses, and an earnest money deposit is a credit toward the purchase price."
                                },
                                {
                                    question: "What is a 'title search'?",
                                    possibleAnswers: ["A search for a buyer for the property.", "A legal review of a property's history to ensure clear ownership.", "A physical inspection of the property's condition.", "A check of the buyer's credit history."],
                                    correctAnswer: "A legal review of a property's history to ensure clear ownership.",
                                    explanation: "A title search is a process to confirm that the person selling the property has the legal right to do so and that there are no liens or other claims against it."
                                }
                            ]
                        },
                        {
                            title: "Escrow and Title",
                            questions: [
                                {
                                    question: "What is the purpose of an escrow account?",
                                    possibleAnswers: ["To hold funds for future property repairs.", "To save for a down payment.", "To hold funds and documents during a real estate transaction.", "To pay the real estate agent's commission."],
                                    correctAnswer: "To hold funds and documents during a real estate transaction.",
                                    explanation: "An escrow account is an account held by a third party (an escrow agent) on behalf of two parties in a transaction, holding the funds and documents until all conditions are met."
                                },
                                {
                                    question: "What is 'title insurance'?",
                                    possibleAnswers: ["Insurance for the physical structure of the home.", "Insurance that protects against financial loss from defects in title to real property.", "Insurance that covers a borrower in case of default.", "Insurance that covers the cost of an appraisal."],
                                    correctAnswer: "Insurance that protects against financial loss from defects in title to real property.",
                                    explanation: "Title insurance protects a policyholder against loss from a title defect, such as a lien, a forged document, or an undisclosed heir."
                                }
                            ]
                        }
                    ]
                },
                {
                    chapter: "Investment Properties",
                    file: "investment-properties.json",
                    lessons: [
                        {
                            title: "Types of Investment",
                            questions: [
                                {
                                    question: "What is the term for a property purchased with the intention of generating income through rent?",
                                    possibleAnswers: ["Primary residence", "Second home", "Rental property", "Vacation home"],
                                    correctAnswer: "Rental property",
                                    explanation: "A rental property is a real estate investment where the owner leases the property to tenants to generate income."
                                },
                                {
                                    question: "What is 'flipping' a property?",
                                    possibleAnswers: ["Selling a property at a loss.", "Buying a property, making improvements, and then selling it for a profit.", "Buying a property to use as a rental.", "The process of refinancing a mortgage."],
                                    correctAnswer: "Buying a property, making improvements, and then selling it for a profit.",
                                    explanation: "Flipping is a real estate investment strategy in which an investor buys a property, renovates it, and quickly sells it for a profit."
                                }
                            ]
                        },
                        {
                            title: "Financial Metrics",
                            questions: [
                                {
                                    question: "What does 'Cap Rate' stand for in real estate investment?",
                                    possibleAnswers: ["Capitalization Rate", "Capital Gains Ratio", "Construction and Planning Ratio", "Cash Asset Percentage"],
                                    correctAnswer: "Capitalization Rate",
                                    explanation: "Capitalization rate (Cap Rate) is the rate of return on a real estate investment property based on the income that the property is expected to generate."
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        // --- Global Variables ---
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = []; // Stores user's selected answers

        // --- DOM Elements ---
        const chapterButtonsContainer = document.getElementById('chapter-buttons-container');
        const loadingText = document.getElementById('loading-text');
        const quizContainer = document.getElementById('quiz-container');
        const mainQuizTitle = document.getElementById('main-quiz-title');
        const quizNavigation = document.getElementById('quiz-navigation');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const searchInput = document.getElementById('search-input');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close');

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            renderChapterButtons();
            modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));
        });

        nextBtn.addEventListener('click', () => {
            handleNavigation(1);
        });

        prevBtn.addEventListener('click', () => {
            handleNavigation(-1);
        });

        searchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            if (searchTerm === '') {
                renderChapterButtons();
            } else {
                searchAndRenderResults(searchTerm);
            }
        });

        // --- Main Functions ---

        /**
         * Fetches and displays quiz questions for a selected lesson.
         * @param {Array<Object>} questions The array of question objects for the selected lesson.
         * @param {string} lessonTitle The title of the lesson.
         */
        function loadLesson(questions, lessonTitle) {
            currentQuestions = questions;
            currentQuestionIndex = 0;
            userAnswers = Array(currentQuestions.length).fill(null);
            mainQuizTitle.textContent = `Quiz: ${lessonTitle}`;
            document.getElementById('initial-message').classList.add('hidden');
            quizNavigation.classList.remove('hidden');
            renderQuestion();
        }

        /**
         * Renders the current question and its answer options to the DOM.
         */
        function renderQuestion() {
            const questionData = currentQuestions[currentQuestionIndex];
            const quizHtml = `
                <div class="space-y-6 animate-pulse" id="question-card">
                    <div class="flex justify-between items-center text-lg text-gray-500">
                        <span class="font-semibold">Question ${currentQuestionIndex + 1} of ${currentQuestions.length}</span>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-lg shadow-inner">
                        <p class="text-xl font-medium text-gray-800">${questionData.question}</p>
                    </div>
                    <div class="space-y-3" id="options-container">
                        ${questionData.possibleAnswers.map((answer, index) => `
                            <button
                                class="w-full text-left py-3 px-4 rounded-lg border-2 border-gray-200 bg-white transition-colors duration-200 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 answer-option"
                                data-index="${index}"
                            >
                                ${answer}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            quizContainer.innerHTML = quizHtml;
            updateNavigationButtons();
            attachAnswerListeners();
            highlightSelectedAnswer();
        }
        
        /**
         * Attaches event listeners to the answer options for the current question.
         */
        function attachAnswerListeners() {
            document.querySelectorAll('.answer-option').forEach(button => {
                button.addEventListener('click', (event) => {
                    const selectedIndex = event.target.dataset.index;
                    userAnswers[currentQuestionIndex] = event.target.textContent;
                    highlightSelectedAnswer();
                    checkAnswer(event.target.textContent);
                });
            });
        }

        /**
         * Highlights the selected answer option for the current question.
         */
        function highlightSelectedAnswer() {
            document.querySelectorAll('.answer-option').forEach(button => {
                button.classList.remove('bg-blue-500', 'text-white', 'border-blue-500', 'font-semibold');
                button.classList.add('bg-white', 'text-gray-800', 'border-gray-200', 'hover:bg-blue-100');
            });
            const selectedAnswer = userAnswers[currentQuestionIndex];
            if (selectedAnswer) {
                const buttons = document.querySelectorAll('.answer-option');
                buttons.forEach(button => {
                    if (button.textContent === selectedAnswer) {
                        button.classList.add('bg-blue-500', 'text-white', 'border-blue-500', 'font-semibold');
                        button.classList.remove('bg-white', 'hover:bg-blue-100');
                    }
                });
            }
        }
        
        /**
         * Checks the user's answer and shows feedback.
         * @param {string} selectedAnswer The answer selected by the user.
         */
        function checkAnswer(selectedAnswer) {
            const correctAnswer = currentQuestions[currentQuestionIndex].correctAnswer;
            const explanation = currentQuestions[currentQuestionIndex].explanation;
            const isCorrect = selectedAnswer === correctAnswer;

            const title = isCorrect ? "Correct!" : "Incorrect";
            const content = isCorrect ? `Great job! ${explanation}` : `The correct answer was: <strong>${correctAnswer}</strong>. ${explanation}`;
            
            showModal(title, content);
        }

        /**
         * Handles navigation between questions.
         * @param {number} direction The direction to move, 1 for next, -1 for previous.
         */
        function handleNavigation(direction) {
            if (currentQuestionIndex + direction < 0) {
                return;
            }

            if (currentQuestionIndex + direction >= currentQuestions.length) {
                // Quiz is complete
                endQuiz();
                return;
            }

            currentQuestionIndex += direction;
            renderQuestion();
        }

        /**
         * Updates the state of the navigation buttons (enabled/disabled).
         */
        function updateNavigationButtons() {
            prevBtn.disabled = currentQuestionIndex === 0;
            if (currentQuestionIndex === currentQuestions.length - 1) {
                nextBtn.textContent = "Finish Quiz";
            } else {
                nextBtn.textContent = "Next »";
            }
        }
        
        /**
         * Renders all chapter buttons to the left sidebar.
         */
        function renderChapterButtons() {
            loadingText.classList.add('hidden');
            chapterButtonsContainer.innerHTML = ''; // Clear previous buttons
            quizData.chapters.forEach(chapterData => {
                const chapterDetails = document.createElement('details');
                chapterDetails.className = 'bg-white rounded-lg shadow-xl';
                
                const chapterSummary = document.createElement('summary');
                chapterSummary.className = 'cursor-pointer flex items-center justify-between p-4 font-semibold text-lg text-gray-700 transition-colors duration-200 hover:bg-gray-100 rounded-lg';
                chapterSummary.innerHTML = `
                    <span>${chapterData.chapter}</span>
                    <svg class="chevron-icon w-6 h-6 text-gray-400 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                `;
                chapterDetails.appendChild(chapterSummary);
                
                const lessonList = document.createElement('div');
                lessonList.className = 'p-2 space-y-2 border-t border-gray-200';
                
                chapterData.lessons.forEach(lessonData => {
                    const lessonButton = document.createElement('button');
                    lessonButton.className = 'w-full text-left py-2 px-4 rounded-lg text-gray-600 font-medium transition-colors duration-200 hover:bg-blue-50';
                    lessonButton.textContent = lessonData.title;
                    lessonButton.addEventListener('click', () => {
                        // Remove active class from all other buttons
                        document.querySelectorAll('.active-lesson-button').forEach(btn => {
                            btn.classList.remove('active-lesson-button');
                        });
                        // Add active class to the clicked button
                        lessonButton.classList.add('active-lesson-button');
                        loadLesson(lessonData.questions, lessonData.title);
                    });
                    lessonList.appendChild(lessonButton);
                });
                
                chapterDetails.appendChild(lessonList);
                chapterButtonsContainer.appendChild(chapterDetails);
            });
        }
        
        /**
         * Searches through all questions for a given search term and renders a list of results.
         * @param {string} searchTerm The term to search for.
         */
        function searchAndRenderResults(searchTerm) {
            let resultsHtml = '';
            let foundCount = 0;
            quizData.chapters.forEach(chapter => {
                chapter.lessons.forEach(lesson => {
                    lesson.questions.forEach(question => {
                        const questionLower = question.question.toLowerCase();
                        const explanationLower = question.explanation.toLowerCase();
                        if (questionLower.includes(searchTerm) || explanationLower.includes(searchTerm)) {
                            foundCount++;
                            resultsHtml += `
                                <details class="bg-gray-100 rounded-lg p-4 shadow mb-4">
                                    <summary class="cursor-pointer font-semibold text-lg text-gray-800">
                                        Question: ${question.question}
                                    </summary>
                                    <div class="mt-4 p-4 bg-white rounded-lg shadow-inner">
                                        <p class="text-sm text-gray-600"><strong>Correct Answer:</strong> ${question.correctAnswer}</p>
                                        <p class="mt-2 text-sm text-gray-600"><strong>Explanation:</strong> ${question.explanation}</p>
                                    </div>
                                </details>
                            `;
                        }
                    });
                });
            });

            if (foundCount > 0) {
                quizContainer.innerHTML = resultsHtml;
                quizNavigation.classList.add('hidden');
                mainQuizTitle.textContent = `Search Results (${foundCount})`;
            } else {
                quizContainer.innerHTML = '<p class="text-center text-gray-500 text-lg">No results found for your search.</p>';
                quizNavigation.classList.add('hidden');
                mainQuizTitle.textContent = "Search Results";
            }
        }
        
        /**
         * Finalizes the quiz, calculates the score, and displays the results.
         */
        function endQuiz() {
            let correctCount = 0;
            currentQuestions.forEach((question, index) => {
                if (userAnswers[index] === question.correctAnswer) {
                    correctCount++;
                }
            });
            const wrongCount = currentQuestions.length - correctCount;

            const title = "Quiz Complete!";
            const content = `You have completed the quiz. You got ${correctCount} correct and ${wrongCount} wrong out of ${currentQuestions.length} questions.`;
            
            showModal(title, content);
            quizNavigation.classList.add('hidden');
            quizContainer.innerHTML = '<p id="initial-message" class="text-center text-gray-500 text-lg">Please select another lesson from the left to begin a new quiz.</p>';
            mainQuizTitle.textContent = "Quiz";
            // Deselect the active button
            document.querySelectorAll('.active-lesson-button').forEach(btn => {
                btn.classList.remove('active-lesson-button');
            });
        }
        
        /**
         * Displays a custom modal with a title and content.
         * @param {string} title The title of the modal.
         * @param {string} content The HTML content of the modal body.
         */
        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }
    </script>

</body>
</html>
